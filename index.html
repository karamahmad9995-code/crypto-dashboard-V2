<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crypto Predictor — v2 (CoinCap)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
:root{--bg:#f7f8fb;--card:#fff;--text:#0f172a;--muted:#64748b;--accent:#1976d2;--ok:#1e8e3e;--bad:#e53935;--warn:#f59e0b;--border:#e5e7eb;--shadow:0 8px 24px rgba(2,6,23,.07)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
.title{font-weight:800;font-size:20px}
.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
@media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
@media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
.sym{border:1px solid var(--border);padding:16px;border-radius:12px;background:#fff;cursor:pointer;text-align:center;font-weight:800}
.sym:hover{outline:2px solid rgba(25,118,210,.35)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:1000px){.row{grid-template-columns:1fr}}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.btn:hover{filter:brightness(.98)}
.btn-primary{background:var(--accent);color:#fff;border-color:transparent}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
.pill.on{background:var(--text);color:#fff;border-color:var(--text)}
.kv{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--border)}
.badge.ok{border-color:#1e8e3e;color:#1e8e3e}

.sparkline{display:grid;grid-template-columns:repeat(25,minmax(12px,1fr));gap:5px;margin-top:8px}
.spark-cell{display:flex;flex-direction:column;align-items:center}
.spark-value{font-size:11px;color:var(--muted);margin-bottom:3px;font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.spark-bar{width:100%;height:12px;background:#e5e7eb;border-radius:4px;transition:background .12s,outline-color .12s;outline:2px solid transparent}
.spark-cell.current .spark-bar{outline-color:rgba(25,118,210,.35)}

.chart-wrap{height:320px;position:relative}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{text-align:left;padding:8px}
thead th{color:var(--muted);border-bottom:1px solid var(--border)}
tbody tr{border-bottom:1px solid var(--border)}
.ok{color:var(--ok);font-weight:800}.bad{color:var(--bad);font-weight:800}.warn{color:var(--warn);font-weight:800}.muted2{color:#94a3b8}
.back{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:var(--text)}
.ev-manual{background:rgba(25,118,210,.06)}
.ev-auto{background:rgba(30,142,62,.06)}
</style>
</head>
<body>
<div class="container">

  <!-- Home -->
  <section id="homeView">
    <header>
      <div>
        <div class="title">Crypto Predictor — v2</div>
        <div class="muted">Select a symbol — summaries show 24h hit-rate (if available)</div>
      </div>
    </header>
    <section class="card"><div id="homeGrid" class="grid"></div></section>
  </section>

  <!-- Coin page -->
  <section id="coinView" style="display:none">
    <header>
      <a class="back" href="#/">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Back</span>
      </a>
      <div class="kv">
        <span class="muted">Contrarian:</span>
        <button id="contrarian" class="pill">Off</button>
        <button id="btnStart" class="btn btn-primary">Start Live</button>
        <button id="btnPredictNow15" class="btn">Predict 15m</button>
        <button id="btnPredictNow60" class="btn">Predict 60m</button>
      </div>
    </header>

    <div class="card">
      <div class="kv" style="justify-content:space-between">
        <div class="kv">
          <div><small class="muted">Symbol</small><div id="symName" style="font-weight:800">—</div></div>
          <div><small class="muted">Current Price</small><div id="currPrice"><strong>—</strong> USD</div></div>
          <div><small class="muted">Model</small><div id="modelInfo"><span class="badge">default v1</span></div></div>
        </div>
        <div class="kv">
          <div><small class="muted">Next 15m</small><div id="nextRun15">—</div></div>
          <div style="margin-left:12px"><small class="muted">Next 60m</small><div id="nextRun60">—</div></div>
        </div>
      </div>
      <div id="spark" class="sparkline"></div>
    </div>

    <div class="row">
      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <div><strong>General Chart</strong> <span class="muted">(auto 60s)</span></div>
          <div>
            <button class="pill range on" data-range="24h">24h</button>
            <button class="pill range" data-range="7d">7d</button>
            <button class="pill range" data-range="30d">30d</button>
          </div>
        </div>
        <div class="chart-wrap"><canvas id="generalChart"></canvas></div>
      </section>
      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <div><strong>Live Chart</strong> <span class="chip">00/15/30/45</span></div>
          <div class="muted">Max ~300 points</div>
        </div>
        <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
      </section>
    </div>

    <div class="row">
      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <strong>Prediction — 15m</strong>
          <span id="srcTag15" class="chip muted2">—</span>
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr">
          <div><small class="muted">Direction</small><div id="predMain15">—</div></div>
          <div><small class="muted">Confidence</small><div id="predConf15">—</div></div>
          <div><small class="muted">Range</small><div id="predRange15">—</div></div>
        </div>
      </section>
      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <strong>Prediction — 60m</strong>
          <span id="srcTag60" class="chip muted2">—</span>
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr">
          <div><small class="muted">Direction</small><div id="predMain60">—</div></div>
          <div><small class="muted">Confidence</small><div id="predConf60">—</div></div>
          <div><small class="muted">Range</small><div id="predRange60">—</div></div>
        </div>
      </section>
    </div>

    <section class="card">
      <div class="kv" style="justify-content:space-between">
        <strong>Evaluation — 15m (range-aware · noise filter)</strong>
        <span class="muted">δ=0.10% · Conf≥62% · Range≥0.30%</span>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Time</th><th>Dir</th><th>Conf</th><th>Range%</th><th>Range Price</th><th>Outcome</th></tr></thead>
          <tbody id="evalBody15"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="kv" style="justify-content:space-between">
        <strong>Evaluation — 60m (range-aware · noise filter)</strong>
        <span class="muted">δ=0.10% · Conf≥62% · Range≥0.30%</span>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Time</th><th>Dir</th><th>Conf</th><th>Range%</th><th>Range Price</th><th>Outcome</th></tr></thead>
          <tbody id="evalBody60"></tbody>
        </table>
      </div>
    </section>
  </section>
</div>

<script>
// ===== API (CoinCap) =====
const COINCAP='https://api.coincap.io/v2';
const BASES=['BTC','ETH','XRP','BNB','SOL','DOGE','ADA','LTC','SHIB','PUMP'];
const SYMBOLS=BASES.map(s=>s+'USDT');
const LIVE_MS=5000, GENERAL_MS=60000, MAX_LIVE=300, SPARK_N=25;

function splitSymbol(sym){return{base:sym.replace(/USDT$/,'').toLowerCase(),quote:'usdt'};}
async function fetchPrice(sym){
  const {base}=splitSymbol(sym);
  const r=await fetch(`${COINCAP}/rates/${base}`,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j=await r.json();
  return Number(j.data.rateUsd);
}
async function fetchKlines(sym,limit){
  const {base,quote}=splitSymbol(sym);
  const end=Date.now(), start=end-limit*60*1000;
  const u=`${COINCAP}/candles?exchange=binance&interval=m1&base=${base}&quote=${quote}&start=${start}&end=${end}`;
  const r=await fetch(u,{cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j=await r.json();
  return j.data.map(k=>({t:k.period||k.time,c:Number(k.close)}));
}
async function fetchJSON(u){try{const r=await fetch(u,{cache:'no-store'});if(!r.ok) return null;return await r.json();}catch(_){return null;}}
async function fetchJSONL(u){
  try{
    const r=await fetch(u,{cache:'no-store'}); if(!r.ok) return [];
    const txt=(await r.text()).trim(); if(!txt) return [];
    return txt.split("\n").map(x=>JSON.parse(x));
  }catch(_){return [];}
}

// ===== Helpers =====
function $(s){return document.querySelector(s);}
function formatPrice(v){v=Number(v);return v>=1? v.toFixed(4) : v.toFixed(6);}
function last(a,n){return a[a.length-(n||1)];}
function nowMs(){return Date.now();}
function fmtUTC(dt){return dt.toISOString().substring(11,19)+' UTC';}

// ===== Routing =====
function route(){
  const h=location.hash||'#/';
  if(h==='#/'||h==='#'){ $('#homeView').style.display=''; $('#coinView').style.display='none'; buildHome(); }
  else if(h.startsWith('#/coin/')){ openCoin(h.split('/')[2]||'BTCUSDT'); }
  else location.hash='#/';
}
window.addEventListener('hashchange',route);

// ===== Home =====
async function buildHome(){
  const grid=$('#homeGrid'); grid.innerHTML='';
  const summary=await fetchJSON('./data/summary.json');
  SYMBOLS.forEach(sym=>{
    const el=document.createElement('div'); el.className='sym';
    const ticker=sym.replace('USDT','');
    let body=`<div style="font-weight:800;margin-bottom:6px">${ticker}</div>`;
    if(summary && summary[sym] && summary[sym].h24){
      body+=`<div class="muted">Hit 24h 15m: <strong>${summary[sym].h24.hit15}%</strong></div>
             <div class="muted">Hit 24h 60m: <strong>${summary[sym].h24.hit60}%</strong></div>`;
    }else{
      body+=`<div class="muted">No summary yet</div>`;
    }
    el.innerHTML=body;
    el.onclick=()=>location.hash='#/coin/'+sym;
    grid.appendChild(el);
  });
}

// ===== Coin page state =====
let activeSym='BTCUSDT', contrarian=false;
let sparkIdx=0, sparkBatch=0, sparkVals=new Array(SPARK_N).fill(null);
let liveTimer=null, genTimer=null;
let generalChart=null, liveChart=null, liveSeries=[];

function resetSpark(){
  sparkIdx=0; sparkBatch=0; sparkVals.fill(null);
  const c=$('#spark'); c.innerHTML='';
  for(let i=0;i<SPARK_N;i++){
    const cell=document.createElement('div'); cell.className='spark-cell';
    const val=document.createElement('div'); val.className='spark-value'; val.textContent='—';
    const bar=document.createElement('div'); bar.className='spark-bar';
    cell.appendChild(val); cell.appendChild(bar); c.appendChild(cell);
  }
}
function clearSparkCells(){
  const cells=$('#spark').children;
  for(let i=0;i<SPARK_N;i++){
    const cell=cells[i];
    cell.querySelector('.spark-bar').style.background='#e5e7eb';
    cell.querySelector('.spark-value').textContent='—';
    cell.classList.remove('current');
  }
}
function updateSpark(price){
  const cells=$('#spark').children;
  if(sparkIdx===0 && sparkBatch>0){ sparkVals.fill(null); clearSparkCells(); }
  sparkVals[sparkIdx]=Number(price);
  const filled=sparkVals.filter(v=>v!==null);
  const mn=Math.min(...filled), mx=Math.max(...filled), span=(mx-mn)||1;
  for(let i=0;i<SPARK_N;i++){
    const v=sparkVals[i], cell=cells[i], bar=cell.querySelector('.spark-bar'), label=cell.querySelector('.spark-value');
    if(v===null){ bar.style.background='#e5e7eb'; label.textContent='—'; cell.classList.remove('current'); continue; }
    const t=(v-mn)/span; const hue=120*t; bar.style.background=`hsl(${hue},70%,45%)`;
    label.textContent=formatPrice(v);
    cell.classList.remove('current');
  }
  cells[sparkIdx].classList.add('current');
  sparkIdx=(sparkIdx+1)%SPARK_N; if(sparkIdx===0) sparkBatch++;
}

// ===== Charts =====
Chart.defaults.font.family='ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial';
Chart.defaults.color='#334155';
const baseOpts={responsive:true,maintainAspectRatio:false,animation:false,parsing:false,
  plugins:{legend:{display:false},decimation:{enabled:true,algorithm:'lttb'},tooltip:{mode:'index',intersect:false}},
  scales:{x:{type:'time',time:{unit:'minute',tooltipFormat:'yyyy-MM-dd HH:mm'}},y:{}}};
function initCharts(){
  const g=$('#generalChart'), l=$('#liveChart');
  if(generalChart){generalChart.destroy();generalChart=null}
  if(liveChart){liveChart.destroy();liveChart=null}
  generalChart=new Chart(g,{type:'line',data:{datasets:[{label:activeSym,data:[],borderColor:'#2e7d32',borderWidth:2,tension:.25,pointRadius:0}]},options:JSON.parse(JSON.stringify(baseOpts))});
  liveChart=new Chart(l,{type:'line',data:{datasets:[{label:activeSym,data:[],borderColor:'#1976d2',borderWidth:2,tension:.25,pointRadius:0}]},options:JSON.parse(JSON.stringify(baseOpts))});
  liveSeries=[];
}
function setGeneral(points){
  generalChart.data.datasets[0].label=activeSym;
  generalChart.data.datasets[0].data=points.map(p=>({x:p.t,y:p.c}));
  generalChart.update('none');
}
function addLivePoint(price){
  liveSeries.push({x:nowMs(),y:price});
  if(liveSeries.length>MAX_LIVE) liveSeries.shift();
  liveChart.data.datasets[0].label=activeSym;
  liveChart.data.datasets[0].data=liveSeries;
  liveChart.update('none');
}
let genRange='24h';
async function loadGeneral(range){
  genRange=range;
  document.querySelectorAll('.pill.range').forEach(b=>b.classList.toggle('on',b.dataset.range===range));
  // نستخدم m1 دائمًا ونغيّر عدد النقاط فقط
  let limit=24*60; if(range==='7d') limit=7*24*60; if(range==='30d') limit=30*24*60;
  try{ const pts=await fetchKlines(activeSym,limit); setGeneral(pts); }catch(e){console.error(e);}
}
function startGeneralAuto(){ if(genTimer) clearInterval(genTimer); genTimer=setInterval(()=>loadGeneral(genRange),GENERAL_MS); }

// ===== Simple predictor (frontend) =====
function ema(a,p){const k=2/(p+1);let prev=a[0];const out=[prev];for(let i=1;i<a.length;i++){prev=a[i]*k+prev*(1-k);out.push(prev);}return out;}
function stddev(a){const m=a.reduce((x,y)=>x+y,0)/a.length;const v=a.reduce((x,y)=>x+(y-m)*(y-m),0)/a.length;return Math.sqrt(v);}
function rsi14(cl){let g=0,l=0;for(let i=1;i<=14;i++){const d=cl[i]-cl[i-1];if(d>=0)g+=d;else l-=d;}const avgG=g/14,avgL=(l/14)||1e-6;const rs=avgG/avgL;return 100-(100/(1+rs));}
function buildFeat(cl){const e5=ema(cl,5),e15=ema(cl,15);const momentum=(last(cl)/cl[0])-1;const rets=[];for(let i=1;i<cl.length;i++)rets.push((cl[i]/cl[i-1])-1);const sigma=stddev(rets);const s5=last(e5)-e5[e5.length-2], s15=last(e15)-e15[e15.length-2];return {rsi:rsi14(cl),s5,s15,momentum,lastRet:last(rets),sigma};}
function sigmoid(z){return 1/(1+Math.exp(-z));}
function predictSimple(f,flip){
  const mu=[50,0,0,0,0,0.003], sd=[12,0.5,0.3,0.01,0.005,0.002];
  const W=[0.35,0.45,0.25,0.80,0.30,-0.15], b=0;
  const x=[f.rsi,f.s5,f.s15,f.momentum,f.lastRet,f.sigma].map((v,i)=>(v-mu[i])/(sd[i]||1));
  const p=sigmoid(W.reduce((s,w,i)=>s+w*x[i],b));
  let dir=p>=0.5?'Up':'Down'; if(flip) dir=(dir==='Up'?'Down':'Up');
  const conf=Math.max(0.55,Math.min(0.95,Math.max(p,1-p)));
  const rng=Math.max(0.2,Math.min(2.0, 0.8*(Math.max(0.0005,f.sigma)*100)+0.6*(Math.abs(f.momentum)*100)));
  return {dir,conf,rangePct:[Math.max(0.10,rng*0.55),rng]};
}
function rangePrice(base,loPct,hiPct,dir){
  const b=Number(base);
  const lo=(dir==='Up')? b*(1+loPct/100) : b*(1-hiPct/100);
  const hi=(dir==='Up')? b*(1+hiPct/100) : b*(1-loPct/100);
  return {lo,hi};
}

// ===== Auto scheduling =====
function nextQuarterUTC(from){const d=new Date(from||Date.now());const m=d.getUTCMinutes();const add=(15-(m%15))%15||15;d.setUTCSeconds(0,0);d.setUTCMinutes(m+add);return d;}
function nextHourUTC(from){const d=new Date(from||Date.now());d.setUTCSeconds(0,0);d.setUTCMinutes(0);d.setUTCHours(d.getUTCHours()+1);return d;}
function setNextRun(dt,el){el.textContent=fmtUTC(dt);}
let auto15=null, auto60=null;
function scheduleAuto(h){
  const el = h===15? $('#nextRun15') : $('#nextRun60');
  const next = h===15? nextQuarterUTC() : nextHourUTC();
  setNextRun(next, el);
  const ms = next.getTime()-Date.now();
  const run = async()=>{ try{ await performPrediction(h,'auto'); } finally { scheduleAuto(h); } };
  const id = setTimeout(run, ms);
  if(h===15){ if(auto15) clearTimeout(auto15); auto15=id; } else { if(auto60) clearTimeout(auto60); auto60=id; }
}
function startSchedulers(){ scheduleAuto(15); scheduleAuto(60); }
function stopSchedulers(){ if(auto15) clearTimeout(auto15); if(auto60) clearTimeout(auto60); auto15=auto60=null; }

// ===== Evaluation table =====
function addEvalRow(h,it){
  const tb = h===15? $('#evalBody15') : $('#evalBody60');
  const tr = document.createElement('tr'); tr.dataset.id=it.id;
  tr.className = (it.src==='auto')? 'ev-auto' : 'ev-manual';
  const sign = it.dir==='Up'? '+' : '-';
  const pctLo=(it.range && it.range[0]!=null? Number(it.range[0]).toFixed(2):'0.00');
  const pctHi=(it.range && it.range[1]!=null? Number(it.range[1]).toFixed(2):pctLo);
  const rangePct = sign+pctLo+'–'+pctHi+'%';
  const rangePrice = formatPrice(it.priceLo)+' → '+formatPrice(it.priceHi);
  const when = new Date(it.t).toLocaleTimeString();
  const srcTag = `<span class="chip">${it.src==='auto'?'Auto':'Manual'}</span>`;
  const outClass = it.outcome==='Pending'?'warn':(it.outcome==='No-Trade'?'muted2':(it.outcome==='Correct'?'ok':'bad'));
  tr.innerHTML = `<td>${when} ${srcTag}</td><td>${it.dir}</td><td>${Math.round((it.conf||0)*100)}%</td><td>${rangePct}</td><td>${rangePrice}</td><td class="${outClass}">${it.outcome}</td>`;
  tb.prepend(tr);
}
function clearEvalTables(){ $('#evalBody15').innerHTML=''; $('#evalBody60').innerHTML=''; }
async function loadServerEval(sym){
  const f15 = await fetchJSONL(`./data/${sym}/15m.jsonl`);
  const f60 = await fetchJSONL(`./data/${sym}/60m.jsonl`);
  [...f15.slice(-200).reverse()].forEach(it=>addEvalRow(15,it));
  [...f60.slice(-200).reverse()].forEach(it=>addEvalRow(60,it));
}

// ===== Predictions (frontend manual/auto) =====
async function performPrediction(h,src){
  src = src || 'manual';
  const need = h===15? 16 : 61;
  const kl = await fetchKlines(activeSym,need);
  const closes = kl.slice(0,-1).map(p=>p.c);
  const base = closes[closes.length-1];
  $('#currPrice').innerHTML='<strong>'+formatPrice(base)+'</strong> USD';

  const feat = buildFeat(closes);
  const res = predictSimple(feat, contrarian);

  const noise = (res.conf<0.62) || (res.rangePct[1]<0.30);
  const dir = res.dir, conf=res.conf, loPct=res.rangePct[0], hiPct=res.rangePct[1];
  const {lo,hi} = rangePrice(base, loPct, hiPct, dir);

  const cardMain = $('#predMain'+h), cardConf=$('#predConf'+h), cardRange=$('#predRange'+h), srcTag=$('#srcTag'+h);
  cardMain.textContent = noise? 'No-Trade' : `${dir} (${Math.round(conf*100)}%)`;
  cardConf.textContent = Math.round(conf*100)+'%';
  // لو المدى ≥0.25% نضمن فرق سعري واضح
  let loTxt = formatPrice(lo), hiTxt = formatPrice(hi);
  if(hiPct>=0.25 && loTxt===hiTxt){ let d=(base>=1?4:6); while(d<8 && loTxt===hiTxt){ d++; loTxt=lo.toFixed(d); hiTxt=hi.toFixed(d); } }
  const sign = dir==='Up'? '+' : '-';
  cardRange.textContent = `${sign}${loPct.toFixed(2)}–${hiPct.toFixed(2)}% · ${loTxt} → ${hiTxt} USD`;
  srcTag.textContent = src==='auto' ? 'Auto' : 'Manual';

  // أضف للجدول (محليًا فقط)
  const row = {
    id:`local-${Date.now()}-${h}`, t:Date.now(), src, dir,
    conf, range:[loPct,hiPct], priceLo:lo, priceHi:hi, base, horizon:h,
    outcome: noise? 'No-Trade' : 'Pending'
  };
  addEvalRow(h,row);
}

// ===== Coin open =====
async function openCoin(sym){
  activeSym = (sym||'BTCUSDT').toUpperCase();
  $('#homeView').style.display='none'; $('#coinView').style.display='';
  $('#symName').textContent=activeSym;

  // أزرار
  $('#contrarian').onclick=()=>{ contrarian=!contrarian; $('#contrarian').textContent = contrarian? 'On':'Off'; };
  $('#btnPredictNow15').onclick=()=>performPrediction(15,'manual');
  $('#btnPredictNow60').onclick=()=>performPrediction(60,'manual');

  // سباركلاين
  resetSpark();

  // شارتات
  initCharts();
  await loadGeneral('24h');
  startGeneralAuto();

  // بث لحظي (سعر + سبارك + شارت لايف)
  if(liveTimer) clearInterval(liveTimer);
  liveSeries=[];
  try{
    const p=await fetchPrice(activeSym);
    $('#currPrice').innerHTML='<strong>'+formatPrice(p)+'</strong> USD';
    addLivePoint(p); updateSpark(p);
  }catch(e){ console.error(e); }
  liveTimer=setInterval(async()=>{
    try{
      const p=await fetchPrice(activeSym);
      $('#currPrice').innerHTML='<strong>'+formatPrice(p)+'</strong> USD';
      addLivePoint(p); updateSpark(p);
    }catch(_){}
  },LIVE_MS);

  // تحميل تقييمات الخادم إن وجدت
  clearEvalTables();
  await loadServerEval(activeSym);

  // جدولة تلقائي
  startSchedulers();

  // اختيار مدى الشارت العام
  document.querySelectorAll('.pill.range').forEach(b=> b.onclick=()=>loadGeneral(b.dataset.range));
}

// ===== Init =====
document.addEventListener('DOMContentLoaded',()=>{
  // زر Start Live اختياري (لإعادة تشغيل البث)
  $('#btnStart').onclick=()=>openCoin(activeSym);
  route();
});
</script>
</body>
</html>
