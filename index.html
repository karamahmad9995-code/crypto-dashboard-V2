<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Predictor — v2 (CoinCap)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
  :root{--bg:#f7f8fb;--card:#fff;--text:#101318;--muted:#5f6b7a;--accent:#1976d2;--ok:#1e8e3e;--bad:#e53935;--warn:#f59e0b;--border:#e5e7eb;--shadow:0 8px 24px rgba(0,0,0,.07)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .title{font-weight:800;font-size:20px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (max-width:700px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .sym{border:1px solid var(--border);padding:16px;border-radius:12px;background:#fff;cursor:pointer;text-align:center;font-weight:800}
  .sym:hover{outline:2px solid rgba(25,118,210,.35)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){.row{grid-template-columns:1fr}}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(.98)}
  .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .pill.on{background:var(--text);color:#fff;border-color:var(--text)}
  .kv{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;background:#fff}
  .sparkline{display:grid;grid-template-columns:repeat(25,minmax(12px,1fr));gap:5px;margin-top:8px}
  .spark-cell{display:flex;flex-direction:column;align-items:center}
  .spark-value{font-size:11px;color:var(--muted);margin-bottom:3px;font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .spark-value.small{font-size:9px}
  .spark-bar{width:100%;height:12px;background:#e5e7eb;border-radius:4px;transition:background .12s,outline-color .12s;outline:2px solid transparent}
  .spark-cell.current .spark-bar{outline-color:rgba(25,118,210,.35)}
  .chart-wrap{height:320px;position:relative}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{text-align:left;padding:8px}
  thead th{color:var(--muted);border-bottom:1px solid var(--border)}
  tbody tr{border-bottom:1px solid var(--border)}
  .ok{color:var(--ok);font-weight:800}.bad{color:var(--bad);font-weight:800}.warn{color:var(--warn);font-weight:800}.muted2{color:#94a3b8}
  .back{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:var(--text)}
  .cards{display:grid;grid-template-columns:1fr;gap:16px}
  .tag{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--border);background:#fff;color:var(--muted)}
  .ev-manual{background:rgba(25,118,210,.06)}
  .ev-auto{background:rgba(30,142,62,.06)}
  .badge{display:inline-block; padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--border);}
  .badge.ok{border-color:#1e8e3e;color:#1e8e3e}
</style>
</head>
<body>
<div class="container">
  <section id="homeView">
    <header>
      <div>
        <div class="title">Crypto Predictor — v2</div>
        <div class="muted">Select a symbol — summary shows 24h hit-rate (if available)</div>
      </div>
    </header>
    <section class="card"><div class="grid" id="homeGrid"></div></section>
  </section>

  <section id="coinView" style="display:none">
    <header>
      <a class="back" href="#/">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Back</span>
      </a>
      <div class="kv">
        <span class="muted">Contrarian:</span>
        <button id="contrarian" class="pill">Off</button>
        <button id="btnStart" class="btn btn-primary">Start Live</button>
        <button id="btnPredictNow15" class="btn">Predict 15m</button>
        <button id="btnPredictNow60" class="btn">Predict 60m</button>
      </div>
    </header>

    <div class="cards">
      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <div class="kv">
            <div><small class="muted">Symbol</small><div id="symName" style="font-weight:800">—</div></div>
            <div><small class="muted">Current Price</small><div id="currPrice"><strong>—</strong> USD</div></div>
            <div><small class="muted">Model</small><div id="modelInfo"><span class="badge">default v1</span></div></div>
          </div>
          <div class="kv">
            <div><small class="muted">Next 15m</small><div id="nextRun15">—</div></div>
            <div style="margin-left:12px"><small class="muted">Next 60m</small><div id="nextRun60">—</div></div>
          </div>
        </div>
        <div id="spark" class="sparkline"></div>
      </section>

      <div class="row">
        <section class="card">
          <div class="kv" style="justify-content:space-between">
            <div><strong>General Chart</strong> <span class="muted">(auto 60s)</span></div>
            <div>
              <button class="pill range on" data-range="24h">24h</button>
              <button class="pill range" data-range="7d">7d</button>
              <button class="pill range" data-range="30d">30d</button>
            </div>
          </div>
          <div class="chart-wrap"><canvas id="generalChart"></canvas></div>
        </section>
        <section class="card">
          <div class="kv" style="justify-content:space-between">
            <div><strong>Live Chart</strong> <span class="chip">00/15/30/45</span></div>
            <div class="muted">Max ~300 points</div>
          </div>
          <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
        </section>
      </div>

      <div class="row">
        <section class="card">
          <div class="kv" style="justify-content:space-between"><strong>Prediction — 15m</strong><span id="modelTag15" class="chip">simple model</span> <span id="srcTag15" class="chip muted2">—</span></div>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr">
            <div><small class="muted">Direction</small><div id="predMain15">—</div></div>
            <div><small class="muted">Confidence</small><div id="predConf15">—</div></div>
            <div><small class="muted">Range</small><div id="predRange15">—</div></div>
          </div>
        </section>
        <section class="card">
          <div class="kv" style="justify-content:space-between"><strong>Prediction — 60m</strong><span id="modelTag60" class="chip">simple model</span> <span id="srcTag60" class="chip muted2">—</span></div>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr">
            <div><small class="muted">Direction</small><div id="predMain60">—</div></div>
            <div><small class="muted">Confidence</small><div id="predConf60">—</div></div>
            <div><small class="muted">Range</small><div id="predRange60">—</div></div>
          </div>
        </section>
      </div>

      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <strong>Evaluation — 15m (range-aware · noise filter)</strong>
          <span class="muted">δ=0.10% · Conf≥62% · Range≥0.30%</span>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>Time</th><th>Dir</th><th>Conf</th><th>Range%</th><th>Range Price</th><th>Outcome</th></tr></thead>
            <tbody id="evalBody15"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="kv" style="justify-content:space-between">
          <strong>Evaluation — 60m (range-aware · noise filter)</strong>
          <span class="muted">δ=0.10% · Conf≥62% · Range≥0.30%</span>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>Time</th><th>Dir</th><th>Conf</th><th>Range%</th><th>Range Price</th><th>Outcome</th></tr></thead>
            <tbody id="evalBody60"></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</div>

<script>
// ---------- App config ----------
const COINCAP = 'https://api.coincap.io/v2';
const BASES = ['BTC','ETH','XRP','BNB','SOL','DOGE','ADA','LTC','SHIB','PUMP'];
const SYMBOLS = BASES.map(s=>s+'USDT');
const LIVE_MS = 5000, GENERAL_MS = 60000, MAX_LIVE = 300, SPARK_N = 25;
const STORAGE_PREFIX = 'coin_ui_state_v2_';

function splitSymbol(sym){ return { base: sym.replace(/USDT$/,'').toLowerCase(), quote:'usdt' }; }
async function fetchPrice(sym){
  const { base } = splitSymbol(sym);
  const r = await fetch(`${COINCAP}/rates/${base}`, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  return Number(j.data.rateUsd);
}
async function fetchKlines(sym, interval, limit){
  const { base, quote } = splitSymbol(sym);
  const end = Date.now();
  const start = end - (limit*60*1000);
  const u = `${COINCAP}/candles?exchange=binance&interval=m1&base=${base}&quote=${quote}&start=${start}&end=${end}`;
  const r = await fetch(u, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  return j.data.map(k => ({ t:k.period || k.time, c:Number(k.close) }));
}

// ---------- Utilities ----------
function $(s){ return document.querySelector(s); }
function nowMs(){ return Date.now(); }
function last(arr, n){ n=n||1; return arr[arr.length-n]; }
function storageKey(sym){ return STORAGE_PREFIX + sym; }
function readState(sym){ try{ return JSON.parse(localStorage.getItem(storageKey(sym))||'{}'); }catch(e){ return {}; } }
function writeState(sym, obj){ try{ localStorage.setItem(storageKey(sym), JSON.stringify(obj)); }catch(e){} }
function formatPriceDyn(v){ return Number(v).toFixed(v>=1?4:6); }

// ---------- Routing ----------
function route(){
  const h = location.hash || '#/';
  if(h==='#/' || h==='#'){
    $('#homeView').style.display='';
    $('#coinView').style.display='none';
    buildHome();
  }else if(h.indexOf('#/coin/')===0){
    const sym = h.split('/')[2] || 'BTCUSDT';
    openCoin(sym.toUpperCase());
  }else{
    location.hash = '#/';
  }
}
window.addEventListener('hashchange', route);

// ---------- Home ----------
async function fetchJSON(u){ try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch(e){ return null; } }
async function buildHome(){
  const grid = $('#homeGrid'); grid.innerHTML='';
  const summary = await fetchJSON('./data/summary.json');
  SYMBOLS.forEach(sym=>{
    const b=document.createElement('div'); b.className='sym';
    const hit = summary && summary[sym] && summary[sym].h24 ? summary[sym].h24 : null;
    b.innerHTML = `<div style="font-weight:800;margin-bottom:6px">${sym.replace('USDT','')}</div>`
      + (hit ? (`<div class="muted">Hit 24h 15m: <strong>${hit.hit15}%</strong></div><div class="muted">Hit 24h 60m: <strong>${hit.hit60}%</strong></div>`)
             : `<div class="muted">No summary yet</div>`);
    b.onclick=()=>{ location.hash = '#/coin/'+sym; };
    grid.appendChild(b);
  });
}

// ---------- Coin view state ----------
let activeSym='BTCUSDT', contrarian=false;
let sparkIdx=0, sparkBatch=0, sparkVals=new Array(SPARK_N).fill(null);
let liveTimer=null, genTimer=null;
let generalChart=null, liveChart=null, liveSeries=[];

function resetSpark(){
  sparkIdx=0; sparkBatch=0; sparkVals.fill(null);
  const c=$('#spark'); c.innerHTML='';
  for(let i=0;i<SPARK_N;i++){
    const cell=document.createElement('div'); cell.className='spark-cell';
    const val=document.createElement('div'); val.className='spark-value'; val.textContent='—';
    const bar=document.createElement('div'); bar.className='spark-bar';
    cell.appendChild(val); cell.appendChild(bar); c.appendChild(cell);
  }
}
function clearSparkCells(){
  const cells=$('#spark').children;
  for(let i=0;i<SPARK_N;i++){
    const cell=cells[i];
    cell.querySelector('.spark-bar').style.background='#e5e7eb';
    cell.querySelector('.spark-value').textContent='—';
    cell.classList.remove('current');
  }
}
function updateSpark(price){
  const c=$('#spark'), cells=c.children;
  if(sparkIdx===0 && sparkBatch>0){ sparkVals.fill(null); clearSparkCells(); }
  sparkVals[sparkIdx]=Number(price);
  const filled=sparkVals.filter(v=>v!==null);
  const mn=Math.min(...filled), mx=Math.max(...filled), span=(mx-mn)||1;
  for(let i=0;i<SPARK_N;i++){
    const v=sparkVals[i], cell=cells[i], bar=cell.querySelector('.spark-bar'), label=cell.querySelector('.spark-value');
    if(v===null){ bar.style.background='#e5e7eb'; label.textContent='—'; cell.classList.remove('current'); continue; }
    const t=(v-mn)/span; const hue=120*t; bar.style.background=`hsl(${hue},70%,45%)`;
    label.textContent = formatPriceDyn(v);
    cell.classList.remove('current');
  }
  cells[sparkIdx].classList.add('current');
  sparkIdx=(sparkIdx+1)%SPARK_N; if(sparkIdx===0) sparkBatch++;
}

// ---------- Charts ----------
Chart.defaults.font.family='ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial';
Chart.defaults.color='#334155';
const baseOpts={responsive:true,maintainAspectRatio:false,animation:false,parsing:false,plugins:{legend:{display:false},decimation:{enabled:true,algorithm:'lttb'},tooltip:{mode:'index',intersect:false}},scales:{x:{type:'time',time:{unit:'minute',tooltipFormat:'yyyy-MM-dd HH:mm'}},y:{}}};
function initCharts(){
  const gctx=$('#generalChart'), lctx=$('#liveChart');
  if(generalChart){generalChart.destroy();generalChart=null}
  if(liveChart){liveChart.destroy();liveChart=null}
  generalChart=new Chart(gctx,{type:'line',data:{datasets:[{label:activeSym,data:[],borderColor:'#2e7d32',borderWidth:2,tension:.25,pointRadius:0}]},options:JSON.parse(JSON.stringify(baseOpts))});
  liveChart=new Chart(lctx,{type:'line',data:{datasets:[{label:activeSym,data:[],borderColor:'#1976d2',borderWidth:2,tension:.25,pointRadius:0}]},options:JSON.parse(JSON.stringify(baseOpts))});
  liveSeries=[];
}
function setGeneralData(points){
  generalChart.data.datasets[0].label=activeSym;
  generalChart.data.datasets[0].data=points.map(p=>({x:p.t,y:p.c}));
  generalChart.update('none');
}
function addLivePoint(price){
  const x=nowMs();
  liveSeries.push({x:x, y:price});
  if(liveSeries.length>MAX_LIVE) liveSeries.shift();
  liveChart.data.datasets[0].label=activeSym;
  liveChart.data.datasets[0].data=liveSeries;
  liveChart.update('none');
}
let currRange='24h';
async function loadGeneral(range){
  currRange=range;
  document.querySelectorAll('.pill.range').forEach(b=>b.classList.toggle('on', b.dataset.range===range));
  // نحافظ على 1m دائماً من CoinCap ونغيّر عدد النقاط
  let limit=288; // 24h = 288×5min تقريبية
  if(range==='7d')  limit=7*24*60;    // 7 أيام × 60 دقيقة
  if(range==='30d') limit=30*24*60;   // 30 يوم × 60 دقيقة
  try{
    const pts = await fetchKlines(activeSym, limit);
    setGeneralData(pts);
  }catch(e){ console.error(e); }
}
function startGeneralAuto(){ if(genTimer) clearInterval(genTimer); genTimer=setInterval(()=>loadGeneral(currRange),GENERAL_MS); }

// ---------- Predictor (frontend simple model for manual/auto cards only) ----------
function emaF(a,p){const k=2/(p+1);let prev=a[0];const o=[prev];for(let i=1;i<a.length;i++){prev=a[i]*k+prev*(1-k);o.push(prev);}return o;}
function stddevF(a){const m=a.reduce((x,y)=>x+y,0)/a.length;const v=a.reduce((x,y)=>x+(y-m)*(y-m),0)/a.length;return Math.sqrt(v);}
function rsi14F(cl){let g=0,l=0;for(let i=1;i<=14;i++){const d=cl[i]-cl[i-1];if(d>=0)g+=d;else l-=d;}const avgG=g/14,avgL=(l/14)||1e-6;const rs=avgG/avgL;return 100-(100/(1+rs));}
function buildFeat(closes){const e5=emaF(closes,5),e15=emaF(closes,15);const momentum=(last(closes)/closes[0])-1;const rets=[];for(let i=1;i<closes.length;i++)rets.push((closes[i]/closes[i-1])-1);const sigma=stddevF(rets),rsi=rsi14F(closes);const s5=last(e5)-e5[e5.length-2],s15=last(e15)-e15[e15.length-2];return {rsi,s5,s15,momentum,lastRet:last(rets),sigma};}
function sigmoid(z){return 1/(1+Math.exp(-z));}
function predictSimple(feat, flip){
  flip=!!flip;
  const mu=[50,0,0,0,0,0.003], sd=[12,0.5,0.3,0.01,0.005,0.002];
  const W=[0.35,0.45,0.25,0.80,0.30,-0.15], b=0;
  const x=[feat.rsi,feat.s5,feat.s15,feat.momentum,feat.lastRet,feat.sigma].map((v,i)=>(v-mu[i])/(sd[i]||1));
  const z=W.reduce((s,w,i)=>s+w*x[i],b), pUp=sigmoid(z);
  let dir=pUp>=0.5?'Up':'Down'; if(flip) dir=(dir==='Up'?'Down':'Up');
  const conf=Math.max(0.55,Math.min(0.95,Math.max(pUp,1-pUp)));
  const rng=Math.max(0.2,Math.min(2.0,0.8*(Math.max(0.0005,feat.sigma)*100)+0.6*(Math.abs(feat.momentum)*100)));
  return {direction:dir,confidence:conf,rangePct:[Math.max(0.10, rng*0.55), rng]};
}
function renderRangePrice(base, loPct, hiPct, dir){
  const b=Number(base);
  const lo = (dir==='Up') ? b*(1+loPct/100) : b*(1-hiPct/100);
  const hi = (dir==='Up') ? b*(1+hiPct/100) : b*(1-loPct/100);
  const dec = (b>=1?4:6);
  let loTxt = lo.toFixed(dec), hiTxt = hi.toFixed(dec);
  if(hiPct>=0.25 && loTxt===hiTxt){ let d=dec; while(d<8 && loTxt===hiTxt){ d++; loTxt=lo.toFixed(d); hiTxt=hi.toFixed(d);} }
  return loTxt+' → '+hiTxt;
}

// ---------- Auto scheduling ----------
function nextQuarterUTC(from){ from=from||new Date(); const d=new Date(from.getTime()); const m=d.getUTCMinutes(); const add=(15-(m%15))%15||15; d.setUTCSeconds(0,0); d.setUTCMinutes(m+add); return d; }
function nextHourUTC(from){ from=from||new Date(); const d=new Date(from.getTime()); d.setUTCSeconds(0,0); d.setUTCMinutes(0); d.setUTCHours(d.getUTCHours()+1); return d; }
function fmtUTC(dt){ return dt.toISOString().substring(11,19)+' UTC'; }
function setNextRun(dt,el){ if(el) el.textContent=fmtUTC(dt); }
let auto15Timeout=null, auto60Timeout=null;
function scheduleAuto(h){
  if(h===15 && auto15Timeout){ clearTimeout(auto15Timeout); auto15Timeout=null; }
  if(h===60 && auto60Timeout){ clearTimeout(auto60Timeout); auto60Timeout=null; }
  const now=new Date();
  const next=(h===15)? nextQuarterUTC(now) : nextHourUTC(now);
  setNextRun(next, h===15? $('#nextRun15') : $('#nextRun60'));
  const ms=Math.max(0,next.getTime()-now.getTime());
  const run=async()=>{ try{ await performPrediction(h,'auto'); }finally{ scheduleAuto(h);} };
  if(h===15) auto15Timeout=setTimeout(run,ms); else auto60Timeout=setTimeout(run,ms);
}
function startAutoSchedulers(){ try{ performPrediction(15,'auto'); }catch(e){} try{ performPrediction(60,'auto'); }catch(e){} scheduleAuto(15); scheduleAuto(60); }
function stopAutoSchedulers(){ if(auto15Timeout) clearTimeout(auto15Timeout); if(auto60Timeout) clearTimeout(auto60Timeout); auto15Timeout=auto60Timeout=null; }

// ---------- Evaluation table helpers ----------
const EVAL_MAX=2000;
function addEvalRow(horizon, obj){
  const tbody = horizon===15? $('#evalBody15') : $('#evalBody60');
  const tr=document.createElement('tr'); tr.dataset.id=obj.id;
  const src=(obj.src||'manual').toLowerCase(); tr.classList.add(src==='auto'?'ev-auto':'ev-manual');
  const sign = obj.dir==='Up'?'+':'-';
  const loPct = (obj.range && obj.range[0]!=null? Number(obj.range[0]).toFixed(2):'0.00');
  const hiPct = (obj.range && obj.range[1]!=null? Number(obj.range[1]).toFixed(2):loPct);
  const pctTxt = sign+loPct+'–'+hiPct+'%';
  const rangeTxt = formatPriceDyn(obj.priceLo)+' → '+formatPriceDyn(obj.priceHi);
  const when = new Date(obj.t).toLocaleTimeString();
  const srcTag = '<span class="tag">'+(src==='auto'?'Auto':'Manual')+'</span>';
  tr.innerHTML = `
    <td>${when} ${srcTag}</td>
    <td>${obj.dir}</td>
    <td>${Math.round(obj.conf*100)}%</td>
    <td>${pctTxt}</td>
    <td>${rangeTxt}</td>
    <td class="${(obj.outcome==='Pending'?'warn':(obj.outcome==='No-Trade'?'muted2':(obj.outcome==='Correct'?'ok':'bad')))}">${obj.outcome}</td>
  `;
  tbody.prepend(tr);
  while(tbody.children.length>EVAL_MAX) tbody.children[tbody.children.length-1].remove();
}
function updateEvalOutcome(horizon, id, ok){
  const tbody = horizon===15? $('#evalBody15') : $('#evalBody60');
  const rows = Array.from(tbody.children);
  const row = rows.find(tr=> tr.dataset.id===id);
  if(row){ const td=row.children[5]; td.textContent = ok? 'Correct':'Wrong'; td.className = ok? 'ok':'bad'; }
}
function clearPredictionCards(){
  ['15','60'].forEach(h=>{
    const m=$('#predMain'+h), c=$('#predConf'+h), r=$('#predRange'+h), tag=$('#srcTag'+h);
    if(m) m.textContent='—'; if(c) c.textContent='—'; if(r) r.textContent='—'; if(tag) tag.textContent='—';
  });
}
function setPredictionCardFromRow(h, it){
  const sign = it.dir==='Up'?'+':'-';
  const pctLo = (it.range && it.range[0]!=null ? it.range[0] : 0); const pctHi = (it.range && it.range[1]!=null ? it.range[1] : 0);
  const mainEl=$('#predMain'+h), confEl=$('#predConf'+h), rngEl=$('#predRange'+h), srcEl=$('#srcTag'+h);
  if(mainEl) mainEl.textContent = (it.outcome==='No-Trade') ? 'No-Trade' : (it.dir+' ('+Math.round((it.conf||0)*100)+'%)');
  if(confEl) confEl.textContent = Math.round((it.conf||0)*100)+'%';
  if(rngEl)  rngEl.textContent  = sign+Number(pctLo).toFixed(2)+'–'+Number(pctHi).toFixed(2)+'% · '+formatPriceDyn(it.priceLo)+' → '+formatPriceDyn(it.priceHi)+' USD';
  if(srcEl)  srcEl.textContent  = (it.src==='auto') ? 'Auto' : 'Manual';
}

// ---------- Perform prediction (front UI only) ----------
async function performPrediction(horizon, src){
  src = src || 'manual';
  try{
    const need = horizon===15?16:61;
    const kl = await fetchKlines(activeSym, need);
    const closes = kl.slice(0,-1).map(p=>p.c);
    const base = closes[closes.length-1];
    $('#currPrice').innerHTML = '<strong>'+formatPriceDyn(base)+'</strong> USD';

    const feat = buildFeat(closes);
    const res = predictSimple(feat, contrarian);

    const noise = (res.confidence<0.62) || (res.rangePct[1]<0.30);
    const label = noise? 'No-Trade' : (res.direction+' ('+Math.round(res.confidence*100)+'%)');

    const sign=(res.direction==='Up')?'+':'-';
    const pctLo = res.rangePct[0].toFixed(
